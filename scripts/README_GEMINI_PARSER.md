# PDF Parser using Gemini API

Скрипт для автоматического парсинга PDF файлов с вопросами "Своя игра" в JSON формат с использованием Gemini API.

## Установка

1. Установите зависимости:
```bash
pip install -r requirements_gemini.txt
```

2. Получите API ключ Gemini:
   - Перейдите на https://makersuite.google.com/app/apikey
   - Создайте API ключ
   - Сохраните его

3. Установите API ключ как переменную окружения:
```bash
export GEMINI_API_KEY='your-api-key-here'
```

Или добавьте в `.bashrc` / `.zshrc`:
```bash
echo 'export GEMINI_API_KEY="your-api-key-here"' >> ~/.zshrc
source ~/.zshrc
```

## Использование

### Базовое использование (chunked mode - рекомендуется):
```bash
python parse_pdf_with_gemini.py "scripts/raw_packs/ШЛМ ИСИ 2025 май.pdf"
```

### Для маленьких файлов (single-shot mode):
```bash
python parse_pdf_with_gemini.py "scripts/raw_packs/small_pack.pdf" --single-shot
```

Результат будет сохранен в `scripts/raw_packs/ШЛМ ИСИ 2025 май_parsed.json`

### Режимы парсинга:

**Chunked mode (по умолчанию)** - рекомендуется для больших пакетов:
- Делает 2 прохода: сначала извлекает структуру, затем парсит каждую тему отдельно
- Не упирается в лимит токенов (8192)
- Показывает прогресс по темам
- Немного медленнее, но надежнее

**Single-shot mode** (`--single-shot`) - для маленьких пакетов:
- Парсит весь PDF за один запрос
- Быстрее, но может упереться в лимит токенов для больших файлов
- Используйте для пакетов с < 5 тем

## Формат выходного JSON

```json
{
  "info": "Информация о пакете, авторы, редакторы, благодарности",
  "package_name": "Название пакета",
  "themes": [
    {
      "name": "Название темы (Автор: Имя)",
      "questions": [
        {
          "cost": 10,
          "question": "В декабре 2012 года В ЧЕСТЬ НЕГО назвали ящерицу",
          "form": "в честь него",
          "answer": "Барак Обама",
          "comment": "комментарий",
          "accept": ["альтернатива"]
        }
      ]
    }
  ]
}
```

## ⚠️ ВАЖНО: Логика поля "form"

**"form" ≠ ответ!**

Поле `"form"` - это **маркер/указание ЧТО нужно назвать**, извлекается из ЗАГЛАВНЫХ слов в вопросе:

### Примеры:

✅ Вопрос: "В ЧЕСТЬ НЕГО назвали ящерицу"
- `"form": "в честь него"`
- `"answer": "Барак Обама"`

✅ Вопрос: "ЭТОГО ГОЛЛАНДЦА упоминают в теории"
- `"form": "голландец"`
- `"answer": "Ян Хендрик Оорт"`

✅ Вопрос: "В ответе одно слово. ОНА называется"
- `"form": "одним словом, она"`
- `"answer": "рука"`

✅ Вопрос: "ОН был профессором"
- `"form": "он"`
- `"answer": "Александр Опарин"`

✅ Вопрос: "ЭТА СТОЛИЦА находится на экваторе"
- `"form": "столица"`
- `"answer": "Кито"`

❌ **НЕПРАВИЛЬНО**: `"form": "Барак Обама"` (это ответ, не форма!)

### Алгоритм извлечения "form":

1. **Ищем ЗАГЛАВНЫЕ местоимения/слова**: ОН, ОНА, ЕГО, ИХ, ИМИ, ЭТОТ ГОРОД, В ЧЕСТЬ НЕГО
2. **Добавляем ограничения** из начала вопроса: "В ответе два слова", "Зачет абсолютно точный"
3. **Извлекаем тип объекта**: ЭТОТ ФРАНЦУЗ → "француз", ЭТА СТОЛИЦА → "столица"
4. **Если есть "Зачет:" в PDF** → создаем поле `"accept": ["вариант1", "вариант2"]`

## Особенности

- **Правильное извлечение "form"**: Извлекает маркер из вопроса (ОН/ОНА/город), а не сам ответ
- **Валидация**: Проверяет наличие всех обязательных полей включая "form"
- **Поддержка языков**: Распознает русский и белорусский ("Адказ:", "Каментар:")
- **Сохранение форматирования**: Ударения, специальные символы
- **Поле "accept"**: Создает отдельное поле для альтернативных зачетов

## Что делает скрипт

### Chunked mode (по умолчанию):
1. Загружает PDF в Gemini API один раз
2. **Первый проход:** Извлекает метаданные и список тем
3. **Второй проход:** Парсит вопросы для каждой темы отдельно
4. Объединяет всё в один JSON
5. Валидирует структуру JSON
6. Сохраняет результат в файл

### Single-shot mode:
1. Загружает PDF в Gemini API
2. Отправляет единый промпт для парсинга всего пакета
3. Получает полный JSON за один запрос
4. Валидирует структуру JSON
5. Сохраняет результат в файл

## Обработка ошибок

Если валидация не прошла (отсутствуют поля "form"), скрипт:
- Выведет список проблемных вопросов
- Спросит, сохранять ли результат
- Позволит отменить или продолжить

## Примеры запуска

Парсинг одного файла:
```bash
python parse_pdf_with_gemini.py "raw_packs/pack1.pdf"
```

Парсинг всех PDF в папке:
```bash
for file in raw_packs/*.pdf; do
    python parse_pdf_with_gemini.py "$file"
done
```

## Ограничения

- Требуется активный API ключ Gemini
- Размер файла ограничен лимитами Gemini API (обычно до 20MB)
- **Chunked mode:** Обработка одного файла может занять 1-3 минуты (зависит от количества тем)
- **Single-shot mode:** Обработка одного файла может занять 30-60 секунд
- Single-shot mode может упереться в лимит токенов (8192) для пакетов с > 5 темами

## Troubleshooting

**Ошибка: GEMINI_API_KEY not set**
```bash
export GEMINI_API_KEY='your-key'
```

**Ошибка: Missing 'form' field**
- Проверьте, что в PDF есть секции "Зачет:" после ответов
- Скрипт попытается использовать сам ответ если зачета нет

**Ошибка: JSON parsing failed или обрезанный JSON**
- Если используете single-shot mode, попробуйте chunked mode (уберите флаг `--single-shot`)
- Gemini мог упереться в лимит токенов (8192) и обрезать ответ
- Chunked mode решает эту проблему, разбивая парсинг на части

**JSON неполный или обрывается на середине**
- Это признак превышения лимита токенов в single-shot mode
- Используйте chunked mode (режим по умолчанию) для больших пакетов
