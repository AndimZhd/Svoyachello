# Gemini Parser для пакетов Своячка

Парсинг PDF/DOCX файлов с вопросами в JSON через Gemini 2.5 Pro API.

## Установка

```bash
pip install -r requirements_gemini.txt
```

Создать `.env` файл:
```bash
GEMINI_API_KEY=your-api-key
```

Получить ключ: https://makersuite.google.com/app/apikey

## Использование

### Один файл (PDF или DOCX)

```bash
python scripts/parse_pdf_with_gemini.py pack.pdf
python scripts/parse_pdf_with_gemini.py pack.docx
```

Результат: `НАЗВАНИЕ_ПАКА_parsed.json` в той же папке.

### Папка с несколькими DOCX

```bash
python scripts/parse_pdf_with_gemini.py Лагерь_Блик_2024_ЭК/
```

Действия:
1. Находит все `.docx` файлы в папке
2. Объединяет их в один DOCX (сохраняет гиперссылки)
3. Парсит объединённый файл
4. Сохраняет `НАЗВАНИЕ_ПАКА_parsed.json` в папке

### Режимы парсинга

**Chunked (по умолчанию)** — рекомендуется:
```bash
python scripts/parse_pdf_with_gemini.py pack.pdf
```
- 2 прохода: структура → каждая тема отдельно
- Не упирается в лимит токенов
- Показывает прогресс по темам

**Single-shot** — для маленьких пакетов (< 5 тем):
```bash
python scripts/parse_pdf_with_gemini.py pack.pdf --single-shot
```
- Парсит весь пакет одним запросом
- Быстрее, но может упереться в лимит токенов

## Формат JSON

```json
{
  "info": "метаданные: авторы, редакторы, мораторий",
  "package_name": "Название пакета",
  "themes": [
    {
      "name": "Тема (Автор: Имя Фамилия)",
      "questions": [
        {
          "cost": 10,
          "question": "В ЧЕСТЬ НЕГО назвали ящерицу...",
          "form": "в честь него",
          "answer": "Барак Обама",
          "comment": "опционально",
          "accept": ["альтернатива1", "альтернатива2"]
        }
      ]
    }
  ]
}
```

### Поле "form"

**Критически важно:** `form` ≠ ответ. Это маркер из вопроса (ЧТО нужно назвать).

**Алгоритм извлечения:**
1. Заглавные местоимения из вопроса:
   - `"В ЧЕСТЬ НЕГО назвали"` → `"form": "в честь него"`
   - `"ЭТОГО ГОЛЛАНДЦА упоминают"` → `"form": "голландец"`
   - `"ОН был профессором"` → `"form": "он"`
   - `"ЭТА СТОЛИЦА находится"` → `"form": "столица"`

2. С ограничениями из начала вопроса:
   - `"В ответе одно слово. ОНА"` → `"form": "одним словом, она"`
   - `"В ответе два слова. ОН"` → `"form": "два слова, он"`

3. Если нет заглавных местоимений:
   - `"Назовите автора"` → `"form": "назовите"`
   - `"Что мы заменили"` → `"form": "что мы заменили"`

## Валидация

Скрипт автоматически проверяет:
- Наличие обязательных полей (`info`, `themes`, `questions`)
- Наличие поля `form` во всех вопросах
- Структуру JSON

При ошибках валидации:
- JSON сохраняется в любом случае
- Выводится предупреждение с указанием проблемных вопросов
- Exit code = 1

## Стоимость API запросов

### Количество запросов

**Chunked режим (N тем):**
- 1 запрос: загрузка файла (бесплатно)
- 1 запрос: структура пакета
- N запросов: парсинг каждой темы
- **Итого:** 1 + N запросов

**Single-shot:**
- 1 запрос: загрузка файла (бесплатно)
- 1 запрос: весь пакет
- **Итого:** 2 запроса

### Примерная стоимость (Gemini 2.5 Pro)

Цены: ~$1.25/1M input токенов, ~$5/1M output токенов

**Пакет 36 тем (180 вопросов):**
- **Chunked:** ~50K input + ~200K output = **~$1.06**
- **Single-shot:** ~100K input + ~500K output = **~$2.75**

**Вывод:** Chunked экономичнее для пакетов > 5 тем (меньше output токенов).


## Добавление пакета в БД

После парсинга добавить в игровую БД:
```bash
python scripts/append_pack.py <short_name> <json_file> --name "<полное название>"
```

**Пример:**
```bash
python scripts/append_pack.py pack2024sep scripts/raw_packs/Пак_Сентябрь_2024_parsed.json --name "Пак вопросов. Сентябрь 2024"
```

## Troubleshooting

| Проблема | Решение |
|----------|---------|
| `User location is not supported` | Нужен VPN (Gemini недоступен в некоторых регионах) |
| `Missing 'form' field` | JSON сохранится с предупреждением. Проверь наличие заглавных местоимений в вопросах |
| JSON обрезан | Используй chunked mode (убери `--single-shot`) |
| `AttributeError: 'str' object has no attribute 'rId'` | Обновлена в последней версии (строка 333) |
| Cyrillic path issues | Скрипт читает файлы как binary, проблема решена |
| DOCX без гиперссылок | Используется `get_or_add_ext_rel` для корректного копирования relationships |

## Зависимости

```
google-genai >= 1.0.0      # Gemini API
python-dotenv >= 1.0.0     # .env файлы
pypdf >= 3.0.0             # Объединение PDF (опционально)
python-docx >= 1.0.0       # Работа с DOCX
reportlab >= 4.0.0         # DOCX→PDF конвертация (опционально)
```

